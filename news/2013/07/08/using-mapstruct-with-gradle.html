<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>
      Using MapStruct with Gradle - MapStruct
    </title>
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <style>
      body {
        padding-top: 60px;
      }
    </style>
    <script src="http://mapstruct.org/javascripts/jquery-1.9.1.min.js" type="text/javascript"></script>
    <script src="http://mapstruct.org/javascripts/bootstrap-tab.js" type="text/javascript"></script>
    <script src="http://mapstruct.org/javascripts/bootstrap-scrollspy.js" type="text/javascript"></script>
    <script src="http://mapstruct.org/javascripts/bootstrap-affix.js" type="text/javascript"></script>
    <link href="http://mapstruct.org/stylesheets/styles.css" rel="stylesheet" type="text/css">
    <!--[if lt IE 9]>
      <script src="//html5shim.googlecode.com/svn/trunk/html5.js" type="text/javascript"></script>
    <![endif]-->
    <link href="http://mapstruct.org/stylesheets/gh-fork-ribbon.css" rel="stylesheet" type="text/css">
    <!--[if IE]>
      <link href="http://mapstruct.org/stylesheets/gh-fork-ribbon.ie.css" rel="stylesheet" type="text/css">
    <![endif]-->
    <link href="http://mapstruct.org/stylesheets/prettify.css" rel="stylesheet" type="text/css">
    <script src="http://mapstruct.org/javascripts/prettify.js" type="text/javascript"></script>
    <script>
      (function(jQuery){
        jQuery( document ).ready( function() {
          prettyPrint();
        } );
      }(jQuery))
    </script>
  </head>
  <body>
    <div class="navbar navbar-fixed-top">
      <div class="hidden-phone pull-right" style="padding-top: 11px; margin-right: 120px;">
        <div class="g-plusone" data-size="medium"></div>
        <script>
          (function() {
            var po = document.createElement('script'); po.type = 'text/javascript'; po.async = true;
            po.src = 'https://apis.google.com/js/plusone.js';
            var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(po, s);
          })();
        </script>
      </div>
      <div class="hidden-phone github-fork-ribbon-wrapper right">
        <div class="github-fork-ribbon">
          <a href="https://github.com/mapstruct/mapstruct">Fork me on GitHub</a>
        </div>
      </div>
      <div class="navbar-inner">
        <div class="container">
          <a class="brand" href="/">MapStruct</a>
          <ul class="nav">
            <li>
              <a href="/">Home</a>
            </li>
            <li>
              <a href="http://mapstruct.org/news">News</a>
            </li>
            <li>
              <a href="http://mapstruct.org/documentation">Documentation</a>
            </li>
            <li>
              <a href="http://mapstruct.org/download">Download</a>
            </li>
            <li>
              <a href="http://mapstruct.org/getting-help">Getting help</a>
            </li>
            <li>
              <a href="http://mapstruct.org/contributing">Contributing</a>
            </li>
          </ul>
        </div>
      </div>
    </div>
    <div class="container">
      <div class="row">
        <div class="span12">
          <div class="post-header">
            <h1>
              Using MapStruct with Gradle
            </h1>
            <h5>
              Gunnar Morling, 08 July 2013, Tags:
              <a href="/news/tags/how-to/">
                how-to
              </a>
              <a href="/news/tags/build/">
                build
              </a>
              <a href="/news/tags/gradle/">
                gradle
              </a>
            </h5>
          </div>
        </div>
      </div>
      <div class="row">
        <div class="span12">
          
          <p>You work with <a href="http://www.gradle.org/">Gradle</a> to build your application and would like to make use of MapStruct to generate mappings between different representations of your model? Then read on to learn how to make MapStruct work with the Groovy based build tool.</p>
          
          <h3 id="background">Background</h3>
          
          <p>MapStruct is implemented in form of an annotation processor as specified by <a href="http://jcp.org/en/jsr/detail?id=269">JSR 269</a>. Annotation processors are plugged into the Java compiler and can inspect the sources during compilation as well as create new sources as it is done by MapStruct. JSR 269 processors can be integrated into basically any form of Java build as long as you work with Java 6 or later.</p>
          
          <p>One way of using an annotation processor is to put its JAR onto the compilation classpath where it will be picked up automatically by the Java compiler. This approach works, but it has the advantage that it exposes the processor and its classes to the compiled application which thus &#150; accidentially or not &#150; could import types from the processor.</p>
          
          <p>This sort of issue can be avoided by setting up the processor separately. When working with <code>javac</code> directly, the <a href="http://docs.oracle.com/javase/7/docs/technotes/tools/solaris/javac.html#options">processorpath</a> option can be used for this purpose, while for Maven projects the <a href="http://code.google.com/p/maven-annotation-plugin/">maven-annotation-plugin</a> is the recommended way to integrate annotation processors.</p>
          
          <h3 id="set-up-mapstruct-in-your-gradle-build">Set up MapStruct in your Gradle build</h3>
          
          <p>To integrate MapStruct into a Gradle build, first make sure you use the Java 6 language level by adding the following to the <em>build.gradle</em> file of your project:</p>
          
          <pre class="prettyprint linenums">&#x000A;ext {&#x000A;    javaLanguageLevel = '1.6'&#x000A;    generatedMapperSourcesDir = "${buildDir}/generated-src/mapstruct/main"&#x000A;}&#x000A;&#x000A;sourceCompatibility = rootProject.javaLanguageLevel</pre>
          
          <p>It's a good idea to declare a property which holds the language level. That way it can be referenced later on where required. We also define a property which specifies the target directory for the generated mapper classes.</p>
          
          <p>The next step is to add the MapStruct annotation module (<em>org.mapstruct:mapstruct:&lt;VERSION&gt;</em>) as compilation dependency and to declare a separate <a href="http://www.gradle.org/docs/current/userguide/dependency_management.html#sub:configurations">dependency configuration</a> which contains the MapStruct processor module (<em>org.mapstruct:mapstruct-processor:&lt;VERSION&gt;</em>):</p>
          
          <pre class="prettyprint linenums">&#x000A;configurations {&#x000A;    mapstruct&#x000A;}&#x000A;&#x000A;dependencies {&#x000A;    compile( 'org.mapstruct:mapstruct:&lt;VERSION&gt;' )&#x000A;    mapstruct( 'org.mapstruct:mapstruct-processor:&lt;VERSION&gt;' )&#x000A;}</pre>
          
          <p>The separate dependency configuration makes sure that the classes from the processor aren't visible to the compiled application. To make the generated sources available for the actual compilation step add the previously configured path to the main <a href="http://www.gradle.org/docs/current/userguide/java_plugin.html#N11D51">source set</a> like this:</p>
          
          <pre class="prettyprint linenums">&#x000A;sourceSets.main {&#x000A;    ext.originalJavaSrcDirs = java.srcDirs&#x000A;    java.srcDir "${generatedMapperSourcesDir}"&#x000A;}</pre>
          
          <p>We also store the original source directories in a property in order to reference them later on. Now it's time to set up a task for the invocation of the annotation processor. To do so, declare a task of the type <a href="http://www.gradle.org/docs/current/dsl/org.gradle.api.tasks.compile.JavaCompile.html">JavaCompile</a> like this:</p>
          
          <pre class="prettyprint linenums">&#x000A;task generateMainMapperClasses(type: JavaCompile) {&#x000A;    ext.aptDumpDir = file( "${buildDir}/tmp/apt/mapstruct" )&#x000A;    destinationDir = aptDumpDir&#x000A;&#x000A;    classpath = compileJava.classpath + configurations.mapstruct&#x000A;    source = sourceSets.main.originalJavaSrcDirs&#x000A;    ext.sourceDestDir = file ( "$generatedMapperSourcesDir" )&#x000A;&#x000A;    options.define(&#x000A;        compilerArgs: [&#x000A;            "-nowarn",&#x000A;            "-proc:only",&#x000A;            "-encoding", "UTF-8",&#x000A;            "-processor", "org.mapstruct.ap.MappingProcessor",&#x000A;            "-s", sourceDestDir.absolutePath,&#x000A;            "-source", rootProject.javaLanguageLevel,&#x000A;            "-target", rootProject.javaLanguageLevel,&#x000A;        ]&#x000A;    );&#x000A;&#x000A;    inputs.dir source&#x000A;    outputs.dir generatedMapperSourcesDir;&#x000A;    doFirst {&#x000A;         sourceDestDir.mkdirs()&#x000A;    }&#x000A;    doLast {&#x000A;        aptDumpDir.delete()&#x000A;    }&#x000A;}</pre>
          
          <p>The task's classpath comprises both, the actual compilation classpath as well as the <code>mapstruct</code> configuration set up before. As source path the previously stored source directories are used.</p>
          
          <p>The options passed to the compile task should be rather self-explanatory. Note that by passing <code>-proc:only</code>, the task will only invoke the given processor but perform no compilation (that will be done by the default compilation step later on).</p>
          
          <p>By declaring the <code>inputs</code> and <code>outputs</code> of the task we make sure Gradle's <a href="http://www.gradle.org/docs/current/userguide/more_about_tasks.html#sec:up_to_date_checks">incremental build</a> functionality is leveraged. That way Gradle will skip the task when running the build a second time and the generated output files still are up to date.</p>
          
          <p>Finally you need to make sure that the generation of mapper types happens before the compilation of all sources. This can be achieved by declaring the following dependency:</p>
          
          <pre class="prettyprint linenums">&#x000A;compileJava.dependsOn generateMainMapperClasses</pre>
          
          <h3 id="give-it-a-shot">Give it a shot</h3>
          
          <p>You can find the complete <a href="https://github.com/mapstruct/mapstruct-examples/blob/master/mapstruct-on-gradle/build.gradle">build.gradle</a> file on GitHub. It is part of an example project which generates a simple mapper class and executes some tests against it. To clone the example project just execute</p>
          
          <pre class="prettyprint lang-sh linenums">&#x000A;git clone https://github.com/mapstruct/mapstruct-examples.git</pre>
          
          <p>You can then build the example by running</p>
          
          <pre class="prettyprint lang-sh linenums">&#x000A;cd mapstruct-on-gradle &amp;&amp; ./gradlew build</pre>
          
          <p>The project comes with the <a href="http://www.gradle.org/docs/current/userguide/userguide_single.html#gradle_wrapper">Gradle Wrapper</a>, a small utility which retrieves the right Gradle version upon the first build. So it is not required to install Gradle separately.</p>
          
          <p>In case you have questions, ideas or any other kind of feedback just add a comment to this post or leave a message in the <a href="https://groups.google.com/forum/?fromgroups#!forum/mapstruct-users">mapstruct-users</a> group.</p>
        </div>
      </div>
      <div class="row">
        <div class="span4">
          <a href="/news/2013/06/03/announcing-mapstruct.html">Previous</a>
        </div>
        <div class="span4" style="text-align: center;">
          <a href="http://mapstruct.org/news">All news</a>
        </div>
        <div class="span4" style="text-align: right;">
        </div>
      </div>
      <div class="row">
        <div class="span12">
          <hr>
          
                      <div id="disqus_thread"></div>
                      <script type="text/javascript">
                      var disqus_shortname = 'mapstruct';
                      var disqus_url = "http://mapstruct.org/news/2013/07/08/using-mapstruct-with-gradle.html";
                      var disqus_developer = null;
                      var disqus_identifier = "7b072fb3512e03deb0cedf4fd9d7a964fb0067cf";
                      (function() {
                        var dsq = document.createElement("script"); dsq.type = "text/javascript"; dsq.async = true;
                        dsq.src = "http://mapstruct.disqus.com/embed.js";
                        (document.getElementsByTagName("head")[0] || document.getElementsByTagName("body")[0]).appendChild(dsq);
                      })();
                      </script>
                      <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript=mapstruct">comments powered by Disqus.</a></noscript>
        </div>
      </div>
      <hr>
      <footer>
        <p>&copy; Gunnar Morling 2013</p>
      </footer>
    </div>
    <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount','UA-41136939-1']);
    _gaq.push(['_gat._anonymizeIp']);
    _gaq.push(['_trackPageview']);
    (function() {
     var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
     ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
     var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
    </script>
  </body>
</html>
